easyblock = 'CMakeMake'

name = 'HPX'
version = '1.7.1'

homepage = 'https://hpx.stellar-group.org/'

description = """HPX is a C++ Standard Library for Concurrency and Parallelism. It implements all of the corresponding
facilities as defined by the C++ Standard. Additionally, in HPX we implement functionalities proposed as part of the
ongoing C++ standardization process. We also extend the C++ Standard APIs to the distributed case."""

toolchain = {'name': 'gompi', 'version': '2021a'}
toolchainopts = {'cstd': 'c++20'}

source_urls = ['https://github.com/STEllAR-GROUP/hpx/archive/refs/tags/']
sources = ['%(version)s.tar.gz']
checksums = ['008a0335def3c551cba31452eda035d7e914e3e4f77eec679eea070ac71bd83b']

builddependencies = [
    ('CMake', '3.20.1'),
    ('pkg-config', '0.29.2'),
]

dependencies = [
    ('Boost', '1.76.0'),
    ('Asio', '1.22.1'),
    ('hwloc', '2.4.1'),
    ('mimalloc', '1.7.2'),
    ('OTF2', '2.3'),
    ('gperftools', '2.9.1'),
    ('PAPI', '6.0.0.1'),
    ('Valgrind', '3.17.0'),
]

# Only consider the unit tests for now.
# Regression and benchmarks are slow and examples require installation first.
configopts = '-DHPX_WITH_TESTS_UNIT=ON '
configopts += '-DHPX_WITH_TESTS_REGRESSIONS=OFF '
configopts += '-DHPX_WITH_TESTS_BENCHMARKS=OFF '
configopts += '-DHPX_WITH_TESTS_EXAMPLES=OFF '
configopts += '-DHPX_WITH_EXAMPLES=OFF '

configopts += '-DHPX_WITH_MALLOC=mimalloc '
configopts += '-DHPX_WITH_PAPI=ON '
configopts += '-DHPX_WITH_TOOLS=ON '
configopts += '-DHPX_WITH_ASYNC_MPI=ON '
configopts += '-DHPX_WITH_GENERIC_CONTEXT_COROUTINES=ON '
configopts += '-DHPX_DATASTRUCTURES-WITH_ADAPT_STD_TUPLE=OFF '
# Optional parameters
# configopts += '-DHPX_WITH_MAX_CPU_COUNT=64 ' 
# configopts += '-DHPX_WITH_MAX_NUMA_DOMAIN_COUNT=8 '

# Some tests have a small chance for false positives when load is to high
# thus we run all tests sequentially
runtest = "tests -j %(parallel)s && ctest -R"

modextrapaths = {'LD_LIBRARY_PATH': 'lib/hpx'}

sanity_check_paths = {
    'files': ['lib/libhpx.%s' % SHLIB_EXT],
    'dirs': ['include/hpx'],
}

sanity_check_commands = ['hello_world_1', 'hello_world_2']

moduleclass = 'lib'
